{
  "AWSTemplateFormatVersion" : "2010-09-09",

  "Description" : "API definition for Visitor assessment",

  "Parameters": {
    "PassedApiKey": {
      "Description" : "API Key is used to call api",
      "Type": "String"
    },
    "PassedPathPart": {
      "Description" : "API resource name",
      "Type": "String"
    },
    "PassedLambdaRoleArn": {
      "Description": "Role for API to Invoke Lambda",
      "Type": "String"
    },
    "PassedApiLogRoleArn": {
      "Description": "Role for API to CloudWatch logs",
      "Type": "String"
    },
    "PassedLambdaFunctionArn": {
      "Description": "Lambda Function to configure as backend for API",
      "Type": "String"
    }
  },

  "Resources" : {

    "VisitorApi": {
      "Type": "AWS::ApiGateway::RestApi",
      "Properties": {
        "Name": "Visitor API",
        "Description": "API for Visitor management."
      }
    },

    "ApiGwAccount": {
      "Type": "AWS::ApiGateway::Account",
      "Properties": {
        "CloudWatchRoleArn": { "Ref": "PassedApiLogRoleArn" }
      },
      "DependsOn": ["VisitorApi"]
    },

    "VisitorResource": {
      "Type": "AWS::ApiGateway::Resource",
      "Properties": {
        "RestApiId": {"Ref": "VisitorApi"},
        "ParentId": {"Fn::GetAtt": ["VisitorApi", "RootResourceId"]},
        "PathPart": { "Ref" : "PassedPathPart" }
      }
    },
  
    "APILambdaPerms": {
      "Type": "AWS::Lambda::Permission",
      "Properties": {
        "Action": "lambda:invokeFunction",
        "FunctionName": { "Ref" : "PassedLambdaFunctionArn" },
        "Principal": "apigateway.amazonaws.com",
        "SourceArn": {"Fn::Join": ["", ["arn:", {"Ref": "AWS::Partition"}, ":execute-api:", {"Ref": "AWS::Region"}, ":", {"Ref": "AWS::AccountId"}, ":", {"Ref": "VisitorApi"}, "/*"]]}
      }
    },

    "VisitorRequest": {
      "Type": "AWS::ApiGateway::Method",
      "Properties": {
        "AuthorizationType": "NONE",
        "HttpMethod": "POST",
        "ResourceId": {"Ref": "VisitorResource"},
        "RestApiId": {"Ref": "VisitorApi"},
        "ApiKeyRequired": true,
        "Integration": {
          "Type": "AWS",
          "IntegrationHttpMethod": "POST",
          "ContentHandling": "CONVERT_TO_TEXT",
          "PassthroughBehavior": "WHEN_NO_MATCH",
          "RequestTemplates": {
            "application/json": "{\"httpMethod\": \"$context.httpMethod\",\"body\": \"$util.escapeJavaScript($input.json('$'))\"}"
          },
          "RequestParameters": {
            "integration.request.header.Content-Type": "'application/x-www-form-urlencoded'"
          }, 
          "Uri": {"Fn::Join": ["",
            ["arn:aws:apigateway:", {"Ref": "AWS::Region"}, ":lambda:path/2015-03-31/functions/", { "Ref" : "PassedLambdaFunctionArn" }, "/invocations"]
          ]},
          "IntegrationResponses": [{
            "ResponseParameters": {
              "method.response.header.Content-Type": "'application/json'",
              "method.response.header.Access-Control-Allow-Origin": "'*'",
              "method.response.header.Access-Control-Allow-Headers": "'Postman-Token,x-api-key,Content-Type'",
              "method.response.header.Access-Control-Allow-Methods": "'POST'"
            },
            "ResponseTemplates": {
              "application/json": ""
            },
            "StatusCode": "200"
          }]
        },
        "RequestModels": {
          "application/json": {"Ref": "VisitorModel"}
        },
        "MethodResponses": [{
          "ResponseModels": {
            "application/json": {"Ref": "VisitorRespModel"}
          },
          "ResponseParameters": {
            "method.response.header.Content-Type": true,
            "method.response.header.Access-Control-Allow-Headers": false,
            "method.response.header.Access-Control-Allow-Methods": false,
            "method.response.header.Access-Control-Allow-Origin": true,
            "method.response.header.Access-Control-Allow-Credentials": false
          },
          "StatusCode": "200"
        }]
      },
      "DependsOn": ["APILambdaPerms"]
    },

    "VisitorRespModel": {
      "Type": "AWS::ApiGateway::Model",
      "Properties": {
        "RestApiId": {"Ref": "VisitorApi"},
        "ContentType": "application/json",
        "Name": "VisitorRespModel",
        "Schema": {
          "properties": {
            "body": { "type": "string" }
          },
          "$schema": "http://json-schema.org/draft-04/schema#",
          "title": "VisitorAPIResponse",
          "type": "object"
        }
      }
    },

    "VisitorModel": {
      "Type": "AWS::ApiGateway::Model",
      "Properties": {
        "RestApiId": {"Ref": "VisitorApi"},
        "ContentType": "application/json",
        "Name": "Visitor",
        "Schema": {
          "properties": {
            "name": {"type": "string"}
          },
          "required": ["name"],
          "type": "object",
          "$schema": "http://json-schema.org/draft-04/schema#"
        }
      }
    },

    "ApiGwDeployment": {
      "Type": "AWS::ApiGateway::Deployment",
      "Properties": {
        "RestApiId": {"Ref": "VisitorApi"}
      },
      "DependsOn": ["VisitorRequest"]
    },

    "VisitorApiStage": {
      "Type": "AWS::ApiGateway::Stage",
      "Properties": {
        "RestApiId": {"Ref": "VisitorApi"},
        "DeploymentId": {"Ref": "ApiGwDeployment"},
        "MethodSettings": [{
          "DataTraceEnabled": true,
          "HttpMethod": "*",
          "LoggingLevel": "INFO",
          "ResourcePath": "/*"
        }],
        "StageName": "PROD"
      },
      "DependsOn": ["ApiGwAccount"]
    },

    "VisitorApiKey": {
      "Type": "AWS::ApiGateway::ApiKey",
      "Properties": {
        "Enabled": true,
        "Name": "VisitorApiKey",
        "StageKeys": [{
          "RestApiId": {"Ref": "VisitorApi"},
          "StageName": {"Ref": "VisitorApiStage"}
        }],
        "Value": { "Ref": "PassedApiKey" }
      }
    },

    "VisitorApiPlan": {
      "Type": "AWS::ApiGateway::UsagePlan",
      "Properties": {
        "ApiStages": [{
          "ApiId": {"Ref": "VisitorApi"},
          "Stage": {"Ref": "VisitorApiStage"},
          "Throttle": {
            "/visitor/POST": {
              "BurstLimit": 10,
              "RateLimit": 10
            }
          }
        }],
        "Quota": {
          "Limit": 500,
          "Period": "WEEK"
        },
        "Throttle": {
          "BurstLimit": 10,
          "RateLimit": 10
        },
        "UsagePlanName": "Basic"
      }
    },

    "VisitorApiPlanKey": {
      "Type": "AWS::ApiGateway::UsagePlanKey",
      "Properties": {
        "KeyId": {"Ref": "VisitorApiKey"},
        "KeyType": "API_KEY",
        "UsagePlanId": {"Ref": "VisitorApiPlan"}
      }
    }
  },
  
  "Outputs" : {
    "VisitorApiEndpoint": {
      "Description": "Root URL of the API gateway",
      "Value": {"Fn::Join": ["", ["https://", {"Ref": "VisitorApi"}, ".execute-api.", {"Ref": "AWS::Region"}, ".", {"Ref": "AWS::URLSuffix"}, "/", {"Ref": "VisitorApiStage"}, "/", {"Ref": "PassedPathPart"}, "/"]]}
    }
  }
}